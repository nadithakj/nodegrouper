<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Excel Compare</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <main class="flex-grow max-w-6xl mx-auto p-6">
        <h1 class="text-2xl font-bold mb-6">Excel File Compare</h1>

        <form method="post" action="/upload_excel_files" enctype="multipart/form-data"
              class="bg-white p-6 rounded-2xl shadow mb-6">
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Upload Template</label>
                    <input type="file" name="file1" required
                           class="mt-1 block w-full text-sm text-gray-700 border rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Report File</label>
                    <input type="file" name="file2" required
                           class="mt-1 block w-full text-sm text-gray-700 border rounded p-2">
                </div>
            </div>
            <button type="submit"
                    class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">
                Upload
            </button>
        </form>

        {% if columns1 and columns2 %}
        <form id="mappingForm" method="post" action="/map_fields" class="bg-white p-6 rounded-2xl shadow">
            <input type="hidden" name="file1" value="{{ file1 }}">
            <input type="hidden" name="file2" value="{{ file2 }}">
            <input type="hidden" name="other_mappings" id="other_mappings">

            <h2 class="text-xl font-semibold mb-4">Map Fields</h2>
            {% if error %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <span class="block sm:inline">{{ error }}</span>
            </div>
            {% endif %}

            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Key Field (Template)</label>
                    <select name="key_field1" required
                             class="mt-1 block w-full border rounded p-2">
                        {% for col in columns1 %}
                        <option value="{{ col }}" {% if selected_key1==col %}selected{% endif %}>{{ col }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Key Field (Report)</label>
                    <select name="key_field2" required
                             class="mt-1 block w-full border rounded p-2">
                        {% for col in columns2 %}
                        <option value="{{ col }}" {% if selected_key2==col %}selected{% endif %}>{{ col }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="mb-6 grid lg:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Template Fields</label>
                    <select id="templateFields" multiple size="10" class="w-full h-48 border rounded p-2 focus:ring focus:ring-blue-200">
                        {% for col in columns1 %}
                            {% if col != selected_key1 %}
                                <option value="{{ col }}">{{ col }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Report Fields</label>
                    <select id="reportFields" multiple size="10" class="w-full h-48 border rounded p-2 focus:ring focus:ring-blue-200">
                        {% for col in columns2 %}
                            {% if col != selected_key2 %}
                                <option value="{{ col }}">{{ col }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mapped Fields</label>
                    <ul id="mappedList" class="w-full h-48 border rounded p-2 overflow-auto bg-gray-100 text-sm">
                        {% if mapped_pairs %}
                            {% for pair in mapped_pairs %}
                                <li class="bg-white p-2 mb-1 rounded flex justify-between items-center">
                                    <span>{{ pair.template }} &rarr; {{ pair.report }}</span>
                                    <button type="button" class="text-red-500 hover:text-red-700" onclick="removeMapping(this)">
                                        &times;
                                    </button>
                                    <input type="hidden" value='{"template": "{{ pair.template }}", "report": "{{ pair.report }}"}'>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            </div>

            <button type="button" id="addMappingBtn"
                    class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow hover:bg-gray-400 mr-2">
                Add Mapping
            </button>
            <button type="submit"
                    class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700">
                Compare
            </button>
        </form>
        {% endif %}

        {% if diffs %}
        <div class="mt-6 bg-white p-6 rounded-2xl shadow">
            <h2 class="text-xl font-semibold mb-4">Differences Found</h2>
            {% for diff in diffs %}
            <div class="mb-4">
                <h3 class="font-semibold text-gray-800">
                    {{ diff.field1 }} â†” {{ diff.field2 }}
                </h3>
                <table class="mt-2 w-full border text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="border px-2 py-1">Key</th>
                            <th class="border px-2 py-1">{{ diff.field1 }} (Template)</th>
                            <th class="border px-2 py-1">{{ diff.field2 }} (Report)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in diff.differences %}
                        <tr>
                            <td class="border px-2 py-1">{{ row[selected_key1] }}</td>
                            <td class="border px-2 py-1">{{ row[diff.field1 ~ "_file1"] }}</td>
                            <td class="border px-2 py-1">{{ row[diff.field2 ~ "_file2"] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const templateFields = document.getElementById('templateFields');
            const reportFields = document.getElementById('reportFields');
            const addMappingBtn = document.getElementById('addMappingBtn');
            const mappedList = document.getElementById('mappedList');
            const otherMappingsInput = document.getElementById('other_mappings');
            const mappingForm = document.getElementById('mappingForm');

            // Initialize or load existing mappings
            let mappedPairs = [];
            if (otherMappingsInput.value) {
                mappedPairs = JSON.parse(otherMappingsInput.value);
            }

            // Function to render the mapped list
            const renderMappedList = () => {
                mappedList.innerHTML = '';
                mappedPairs.forEach(pair => {
                    const li = document.createElement('li');
                    li.className = 'bg-white p-2 mb-1 rounded flex justify-between items-center';
                    li.innerHTML = `
                        <span>${pair.template} &rarr; ${pair.report}</span>
                        <button type="button" class="text-red-500 hover:text-red-700" onclick="removeMapping(this)">
                            &times;
                        </button>
                        <input type="hidden" value='${JSON.stringify(pair)}'>
                    `;
                    mappedList.appendChild(li);
                });
            };

            // Event listener for the "Add Mapping" button
            addMappingBtn.addEventListener('click', () => {
                const templateField = templateFields.value;
                const reportField = reportFields.value;

                if (templateField && reportField) {
                    const newPair = { template: templateField, report: reportField };
                    if (!mappedPairs.some(p => p.template === newPair.template || p.report === newPair.report)) {
                         mappedPairs.push(newPair);
                         renderMappedList();
                    } else {
                        alert("A field can only be mapped once!");
                    }
                } else {
                    alert('Please select a field from both lists.');
                }
            });

            // Function to remove a mapping
            window.removeMapping = (button) => {
                const li = button.parentElement;
                const pairValue = JSON.parse(li.querySelector('input[type="hidden"]').value);
                mappedPairs = mappedPairs.filter(pair => !(pair.template === pairValue.template && pair.report === pairValue.report));
                renderMappedList();
            };

            // Before form submission, populate the hidden input
            mappingForm.addEventListener('submit', () => {
                otherMappingsInput.value = JSON.stringify(mappedPairs);
            });
        });
    </script>
</body>
</html>
