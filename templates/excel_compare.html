<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Excel Compare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 flex flex-col font-sans">

    <div class="p-4">
        <a href="/" 
           class="flex items-center bg-gray-700 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-800 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 2.5l-7 7V17a1 1 0 001 1h4a1 1 0 001-1v-3h2v3a1 1 0 001 1h4a1 1 0 001-1v-7.5l-7-7z"/>
            </svg>
            Back to Home
        </a>
    </div>

    <main class="flex-grow max-w-6xl mx-auto p-6">
        <h1 class="text-5xl font-extrabold mb-10 text-center text-gray-800">
            Excel <span class="text-blue-600">Compare</span>
        </h1>

        <div class="bg-white p-6 rounded-2xl shadow mb-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Upload Excel Files</h2>
            <form method="post" action="/upload_excel_files" enctype="multipart/form-data">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Upload Template</label>
                        <input type="file" name="file1" required class="mt-1 block w-full text-sm text-gray-700 border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Report File</label>
                        <input type="file" name="file2" required class="mt-1 block w-full text-sm text-gray-700 border rounded p-2">
                    </div>
                </div>
                <button type="submit" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">
                    Upload
                </button>
            </form>
        </div>

        {% if error %}
        <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-xl shadow mb-6" role="alert">
            <p>{{ error }}</p>
        </div>
        {% endif %}

        {% if columns1 and not selected_key1 %}
        <form method="post" action="/select_key" class="bg-white p-6 rounded-2xl shadow">
            <h2 class="text-xl font-semibold mb-4">Step 1: Select Key Fields</h2>
            <input type="hidden" name="file1" value="{{ file1 }}">
            <input type="hidden" name="file2" value="{{ file2 }}">
            
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Key Field (Template)</label>
                    <select name="key_field1" required class="mt-1 block w-full border rounded p-2">
                        {% for col in columns1 %}
                        <option value="{{ col }}">{{ col }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Key Field (Report)</label>
                    <select name="key_field2" required class="mt-1 block w-full border rounded p-2">
                        {% for col in columns2 %}
                        <option value="{{ col }}">{{ col }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">
                Next
            </button>
        </form>
        {% endif %}

        {% if selected_key1 %}
        <form id="mappingForm" method="post" action="/map_fields" class="bg-white p-6 rounded-2xl shadow">
            <h2 class="text-xl font-semibold mb-4">Step 2: Map Other Fields</h2>
            <input type="hidden" name="file1" value="{{ file1 }}">
            <input type="hidden" name="file2" value="{{ file2 }}">
            <input type="hidden" name="key_field1" value="{{ selected_key1 }}">
            <input type="hidden" name="key_field2" value="{{ selected_key2 }}">
            <input type="hidden" name="other_mappings" id="other_mappings">
            
            <div class="mb-4">
                <p class="text-sm font-medium text-gray-700">Selected Key Fields:</p>
                <p class="font-semibold">{{ selected_key1 }} &rarr; {{ selected_key2 }}</p>
            </div>
            
            <div class="mb-6 grid lg:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Template Fields</label>
                    <select id="templateFields" multiple size="10" class="w-full h-48 border rounded p-2 focus:ring focus:ring-blue-200">
                        {% for col in columns1 %}
                            {% if col != selected_key1 %}
                            <option value="{{ col }}">{{ col }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Report Fields</label>
                    <select id="reportFields" multiple size="10" class="w-full h-48 border rounded p-2 focus:ring focus:ring-blue-200">
                        {% for col in columns2 %}
                            {% if col != selected_key2 %}
                            <option value="{{ col }}">{{ col }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mapped Fields</label>
                    <ul id="mappedList" class="w-full h-48 border rounded p-2 overflow-auto bg-gray-100 text-sm">
                         {% if mapped_pairs %}
                            {% for pair in mapped_pairs %}
                                <li class="bg-white p-2 mb-1 rounded flex justify-between items-center">
                                    <span>{{ pair.template }} &rarr; {{ pair.report }}</span>
                                    <button type="button" class="text-red-500 hover:text-red-700" onclick="removeMapping(this)">
                                        &times;
                                    </button>
                                    <input type="hidden" value='{"template": "{{ pair.template }}", "report": "{{ pair.report }}"}'>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            </div>

            <button type="button" id="addMappingBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg shadow hover:bg-gray-400 mr-2">
                Add Mapping
            </button>
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700">
                Compare
            </button>
        </form>
        {% endif %}

        {% if diffs %}
        <div class="mt-6 bg-white p-6 rounded-2xl shadow">
            <h2 class="text-xl font-semibold mb-4">Differences Found</h2>
            {% for diff in diffs %}
            <div class="mb-4">
                <h3 class="font-semibold text-gray-800">
                    {{ diff.field1 }} â†” {{ diff.field2 }}
                </h3>
                <table class="mt-2 w-full border text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="border px-2 py-1">Key</th>
                            <th class="border px-2 py-1">{{ diff.field1 }} (Template)</th>
                            <th class="border px-2 py-1">{{ diff.field2 }} (Report)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in diff.differences %}
                        <tr>
                            <td class="border px-2 py-1">{{ row[selected_key1] }}</td>
                            <td class="border px-2 py-1">{{ row[diff.field1 ~ "_file1"] if diff.field1 ~ "_file1" in row else row[diff.field1] }}</td>
                            <td class="border px-2 py-1">{{ row[diff.field2 ~ "_file2"] if diff.field2 ~ "_file2" in row else row[diff.field2] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </main>

    <footer class="p-6 text-center text-gray-500 text-sm border-t border-gray-200 mt-auto">
        &copy; 2025 Nadi Jayasekara. All rights reserved.
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const templateFields = document.getElementById('templateFields');
            const reportFields = document.getElementById('reportFields');
            const addMappingBtn = document.getElementById('addMappingBtn');
            const mappedList = document.getElementById('mappedList');
            const otherMappingsInput = document.getElementById('other_mappings');
            const mappingForm = document.getElementById('mappingForm');

            let mappedPairs = [];
            if (otherMappingsInput && otherMappingsInput.value) {
                try {
                    mappedPairs = JSON.parse(otherMappingsInput.value);
                } catch (e) {
                    console.error("Failed to parse existing mappings:", e);
                }
            }

            const renderMappedList = () => {
                mappedList.innerHTML = '';
                mappedPairs.forEach(pair => {
                    const li = document.createElement('li');
                    li.className = 'bg-white p-2 mb-1 rounded flex justify-between items-center';
                    li.innerHTML = `
                        <span>${pair.template} &rarr; ${pair.report}</span>
                        <button type="button" class="text-red-500 hover:text-red-700" onclick="removeMapping(this)">
                            &times;
                        </button>
                        <input type="hidden" value='${JSON.stringify(pair)}'>
                    `;
                    mappedList.appendChild(li);
                });
            };

            if (addMappingBtn) {
                addMappingBtn.addEventListener('click', () => {
                    const templateField = templateFields.value;
                    const reportField = reportFields.value;

                    if (templateField && reportField) {
                        const newPair = { template: templateField, report: reportField };
                        if (!mappedPairs.some(p => p.template === newPair.template || p.report === newPair.report)) {
                            mappedPairs.push(newPair);
                            renderMappedList();
                        } else {
                            alert("A field can only be mapped once!");
                        }
                    } else {
                        alert('Please select a field from both lists.');
                    }
                });
            }

            window.removeMapping = (button) => {
                const li = button.parentElement;
                const pairValue = JSON.parse(li.querySelector('input[type="hidden"]').value);
                mappedPairs = mappedPairs.filter(pair => !(pair.template === pairValue.template && pair.report === pairValue.report));
                renderMappedList();
            };

            if (mappingForm) {
                mappingForm.addEventListener('submit', () => {
                    otherMappingsInput.value = JSON.stringify(mappedPairs);
                });
            }

            renderMappedList();
        });
    </script>
</body>
</html>
